<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
	<meta charset="utf-8" />
    <link rel="stylesheet" href="scripts/reset.css" />
    <script src="scripts/jquery-1.8.2.js"></script>
    <script src="scripts/three.min.js"></script>
    <!--<script src="scripts/DDSLoader.js"></script>-->
    <script src="scripts/stats.js"></script>
    <script src="scripts/dat.gui.min.js"></script>
    <script src="scripts/OrbitControls.js"></script>
    <script src="scripts/GLTFLoader.js"></script>
    <script src="scripts/FirstPersonControls.js"></script>
    <script src="scripts/html2canvas.js"></script>
    <script src="scripts/Tween.js"></script>
    <script src="scripts/CSS3DRenderer.js"></script>
    <script>
        "use strict";
        ///////////////////获取数据库数据/////////////////////////
        var jsonData;
        function mouseClick(bim_uid) {
            var xml = $.parseXML(jsonData[bim_uid]);
            getmessage(messageGui, xml, function () {
                $(xml).find('*:first').each(function (i) {
                    messageGui = gui.addFolder("设备信息");
                    fn($(this));
                });
            });
        }
        function getmessage(messageGui, xml, callback) {
            /*if (messageGui) {
                gui.removeFolder(messageGui);
            } else { }*/
            messageGui == undefined ? null : gui.removeFolder(messageGui);
            callback();
        }
        /*function getmessage(xml) {


            $("#c").empty();
            if (messageGui) {
                gui.removeFolder(messageGui);
            } else { }
            $(xml).find('*:first').each(function (i) {
                messageGui = gui.addFolder("设备信息");
                fn($(this));
            });
        }*/
        var getBiminfo = function () {
            $.ajax({
                type: "POST",
                url: "/Handler3D.ashx?action=getbiminfo",
                dataType: "html",
                data: {
                },
                timeout: 20000,
                success: function (data) {
                    jsonData = $.parseJSON(data);
                }
            });
        };
        getBiminfo();
        var M_DOT = 0;
        var xmlObj = {};
        function fn(obj) {
            var myObj = obj[0].attributes;
            $(myObj).each(function (i) {
                var nodeJson = $.parseJSON($(this)[0].nodeValue);
                if (M_DOT == 0 && nodeJson.Name != undefined) {
                    var messageGui0 = messageGui.addFolder(nodeJson.Name);
                } else if (M_DOT == 1 && nodeJson.Name != undefined) {
                    if (Object.keys(xmlObj).length > 0) {
                        for (var key in xmlObj) {
                            messageGui1.add(xmlObj, key);
                        }
                    }
                    messageGui1 = messageGui0.addFolder(nodeJson.Name);
                    xmlObj = {};
                } else if (M_DOT == 2 && nodeJson.Name != undefined && nodeJson.NominalValue != undefined) {
                    xmlObj[nodeJson.Name] = nodeJson.NominalValue;
                }
            })
            if (obj.length > 0) {
                obj.children().each(function (i) {
                    M_DOT++;
                    fn($(this));
                    M_DOT--;
                })
            } else {
                return false;
            }
        }


        ///////////////////////////////////////////////////////////threejs的基本///////////////////////////////////////////////////////////////////

        //场景
        var scene;
        var cssScene;
        function initScene() {
            scene = new THREE.Scene();
            cssScene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x72645b, 10, 1000);
        }
        //渲染器
        var renderer;
        var rendererCSS;
        var width = window.innerWidth;
        var height = window.innerHeight;
        function initThree() {

            renderer = new THREE.WebGLRenderer({ antialias: true,alpha: true });
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = 0;
            // make sure original renderer appears on top of CSS renderer
            renderer.domElement.style.zIndex = -1;
            renderer.setSize(width, height);
            document.getElementById("canvas3d").appendChild(renderer.domElement);
            renderer.setClearColor(0x000000, 1.0);
            rendererCSS = new THREE.CSS3DRenderer({ alpha: true });
            rendererCSS.domElement.style.position = 'absolute';
            rendererCSS.domElement.style.top = 0;
            rendererCSS.domElement.style.margin = 0;
            rendererCSS.domElement.style.padding = 0;
            rendererCSS.setSize(width, height);
            document.getElementById("canvas3d").appendChild(rendererCSS.domElement);
        }
        //相机
        var camera;
        function initCamera() {
            camera = new THREE.PerspectiveCamera(45, width / height, 1, 20000);
            camera.position.set(0, 0, 20);
            camera.up.set(0, 1, 0);
            camera.lookAt(new THREE.Vector3(0, 0, 0));
        }
        //总体浏览控制器
        var controls;
        function initControls() {
            controls = new THREE.OrbitControls(camera, rendererCSS.domElement);
            // 如果使用animate方法时，将此函数删除
            //controls.addEventListener( 'change', render );
            // 使动画循环使用时阻尼或自转 意思是否有惯性
            controls.enableDamping = false;
            //动态阻尼系数 就是鼠标拖拽旋转灵敏度
            controls.dampingFactor = 0.1;
            //是否可以缩放
            controls.enableZoom = true;
            //是否自动旋转
            controls.autoRotate = false;
            //设置相机距离原点的最近距离
            controls.minDistance = 0;
            //设置相机距离原点的最远距离
            controls.maxDistance = 10000;
            //是否开启右键拖拽
            controls.enablePan = true;
        }
        //第一人称浏览控制器
        function initControls1() {
            controls = null;
            controls = new THREE.FirstPe3rsonControls(camera, renderer.domElement);
            controls.lookSpeed = 0.1; //鼠标移动查看的速度
            controls.movementSpeed = 1; //相机移动速度
            controls.noFly = false;
            controls.constrainVertical = false; //约束垂直
        }
        //灯光
        function initLight() {
            //自然光
            var light = new THREE.AmbientLight(0x0c0c0c);
            scene.add(light);
            //半球光
            var hemiLight = new THREE.HemisphereLight(0xffffff, 0xfcfcfc);
            hemiLight.position.set(0, 15000, 0);
            scene.add(hemiLight);
            //太阳光
            var sunLight = new THREE.SpotLight(0x00bfff, 0.5, 34000);
            sunLight.position.set(14000, 10000, 12000);
            scene.add(sunLight);
        }
        //场景背景
        function getskyBox() {
            scene.background = new THREE.CubeTextureLoader().setPath('./model/').load(["posx.jpg", "negx.jpg", "posy.jpg", "negy.jpg", "posz.jpg", "negz.jpg"]);
        }
        //渲染器刷新
        function render() {
            controls.update();
            renderer.render(scene, camera);
            rendererCSS.render(cssScene, camera);
            window.onresize = onWindowResize;
        }
        //动画

        function animate() {
            render();
            requestAnimationFrame(animate);
            stats.update();
            likeHover(html);
            TWEEN.update();
            Controls3Dtext();
            /*精灵材质动画(暂无使用)*/
            //var delta = clock.getDelta();
            //v.update(1000 * delta);
        }
        //窗口更新函数
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            rendererCSS.setSize(window.innerWidth, window.innerHeight);
        }
        //加载时运行
        function threeStart() {
            initThree();
            initCamera();
            initScene();
            initLight();
            loadGLTF('./model/', '123');
            //getskyBox();
            addParticles();
            //creatSprite();
            initControls();
            initGui();
            initStats();
            animate();
            initModel("测试水泵名称！","qwer123");
        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


        //粒子
        function createCanvas(width, height, colors) {//创建画布并绘制精灵纹理
            var canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            var context = canvas.getContext('2d');
            var gradient = context.createRadialGradient(canvas.width / 2, canvas.height / 2, 0, canvas.width / 2, canvas.height / 2, canvas.width / 2);
            colors.forEach(function (color) {
                gradient.addColorStop(color.start, color.rgba);
            })
            context.fillStyle = gradient;
            context.fillRect(0, 0, canvas.width, canvas.height);
            return canvas;
        }
        function createMaterial(width, height, colors) {//使用画布创建材质
            var sprite = createCanvas(width, height, colors);
            return new THREE.SpriteMaterial({
                map: new THREE.CanvasTexture(sprite),
                blending: THREE.AdditiveBlending,
                overdraw: false,
                depthWrite: false
            })
        }
        var particles = [];
        function addParticles() {
            for (var i = 0; i < 1; i++) {
                var deepColor = Math.round(Math.random() * 255);
                var lightColor = Math.round(deepColor * 32 / 255);
                var material = createMaterial(32, 32, [
                    { start: 0, rgba: 'rgba(255,255,255,1)' },
                    { start: 0.2, rgba: 'rgba(0,' + deepColor + ',' + Math.round(Math.random() * 80 + 175) + ',1)' },
                    { start: 0.4, rgba: 'rgba(0,' + lightColor + ',64,1)' },
                    { start: 1, rgba: 'rgba(0,0,0,1)' }
                ])
                var particle = new THREE.Sprite(material);
                particles.push(particle);
                var delay = i * 5;
                particle = particle ? particle : this;
                initParticle(particle, new THREE.Vector3(Math.random() * 200 - 100, Math.random() * 200 - 100, Math.random() * 200 - 100), Math.random());
                particleLoop(particle, delay)
                scene.add(particle);
            }
        }
        function initParticle(particle, coord, size) {
            var particle = this instanceof THREE.Sprite ? this : particle;
            if (!size && size != 0) {
                size = Math.random() * 32 + 16;
            }
            particle.scale.x = particle.scale.y = size;
            particle.position.set(coord.x, coord.y, coord.z);
        }
        function particleLoop(particle, delay) {
            delay = delay ? delay : 0;
            console.log(delay);
            //initParticle(particle, new THREE.Vector3(Math.random() * 200 - 100, Math.random() * 200 - 100, Math.random() * 200 - 100), Math.random());
            //initParticle(particle, new THREE.Vector3(0, 0, 0), Math.random());
            new TWEEN.Tween(particle)
                .delay(delay)
                .to({}, 20000)
                .onComplete(particleLoop)
                .onStart(function () {
                })
                .start();
            new TWEEN.Tween(particle.position)
                .delay(delay)
                .to({ x: Math.random() * 200 - 100, y: Math.random() * 200 - 100, z: Math.random() * 200 - 100 },20000)
                //.to({ x: 0, y: 0, z: 0 }, 1000)
                .start();

            new TWEEN.Tween(particle.scale)
                .delay(delay)
                .to({ x: 1, y: 1 }, 1000)
                .start();
        }

        //定义objects数组用于存放模型里的Mesh
        var objects = [];
        //加载外部模型
        var gltfobj;
        function loadGLTF(path, fileName) {
            var loader = new THREE.GLTFLoader();
            loader.load(`${path}${fileName}.gltf`, function (gltf) {
                var object = gltf.scene;
                gltfobj = object.children;
                scene.add(object);
                object.rotation.x = THREE.Math.degToRad(-90);
                object.rotation.z = THREE.Math.degToRad(180);
                //模型居中
                var center = new THREE.Box3().expandByObject(object).getCenter(new THREE.Vector3());
                object.position.set(-center.x, -center.y, -center.z);
                //object.children.forEach(function (children) {});
                //traverseTree(object)
            });
        }
        //递归将模型里的mesh找出并加到objects数组
        function traverseObj(object) {
            //获取children数组
            var children = object.children;
            //如果当前模型有子元素，则遍历子元素
            if (children && children.length > 0) {
                children.forEach(function (e) {
                    traverseObj(e);
                });
            }
            else {
                if (object instanceof THREE.Mesh) {
                    objects.push(object);
                }
            }
        }

        /*function traverseTree(obj) {
            if (!obj) {
                return;
            }
            if (obj.children && obj.children.length > 0) {
                for (var i = 0; i < obj.children.length; i++) {
                    traverseTree(obj.children[i]);
                }
            }
            else {
                if (obj instanceof THREE.Mesh) {
                    objects.push(obj);
                }
            }
        }*/

        //windows监听事件
        window.addEventListener('click', onMouseClick, false);
        window.addEventListener('mousemove', onMouseMove, false);
        var mouseValue = true;
        window.addEventListener('mousedown', function () {
            mouseValue = false;
        }, false);
        window.addEventListener('mouseup', function () {
            mouseValue = true;
        }, false);
        window.addEventListener('mousewheel', onMouseWheel, false);
        function onMouseWheel(ev) {

            var factor = 3;

            var WIDTH = window.innerWidth;
            var HEIGHT = window.innerHeight;

            //将鼠标的屏幕坐标转换为NDC坐标
            var mX = (ev.clientX / WIDTH) * 2 - 1;
            var mY = -(ev.clientY / HEIGHT) * 2 + 1;

            //这里定义深度值为0.5，深度值越大，意味着精度越高
            var vector = new THREE.Vector3(mX, mY, 1);
            //将鼠标坐标转换为3D空间坐标
            vector.unproject(camera);

            //获得从相机指向鼠标所对应的3D空间点的射线（归一化）
            vector.sub(camera.position).normalize();
            var delta = Math.max(-1, Math.min(1, (ev.wheelDelta || -ev.detail)));
            if (delta > 0) {
                camera.position.x += vector.x * factor;
                camera.position.y += vector.y * factor;
                camera.position.z += vector.z * factor;
                controls.target.x += vector.x * factor;
                controls.target.y += vector.y * factor;
                controls.target.z += vector.z * factor;
            } else {
                camera.position.x -= vector.x * factor;
                camera.position.y -= vector.y * factor;
                camera.position.z -= vector.z * factor;
                controls.target.x -= vector.x * factor;
                controls.target.y -= vector.y * factor;
                controls.target.z -= vector.z * factor;
            }
        };

        //声明raycaster和mouse变量
        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();
        var intersects;
        var eventMouse;
        function onMouseMove(event) {
            if (mouseValue) {
                event.preventDefault();
                eventMouse = { x: event.clientX, y: event.clientY };
                //$("#div_message").css({ left: event.clientX + 5, top: event.clientY + 5 });
                mouse.x = ((event.clientX) / window.innerWidth) * 2 - 1;
                mouse.y = -((event.clientY) / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                intersects = raycaster.intersectObjects(gltfobj, true);//遍历所有mesh，mesh:网格
            }
        }
        var threeMesh;
        var normalMaterial = new THREE.MeshNormalMaterial();
        function changeClick() {
            divclickvalue = true;
            gltfclickvalue = false;
        }

        /*function change() {
            Go = window.setTimeout(function () {
                if (document.getElementById("css3Ddiv") != null) {
                    clearTimeout(Go);
                    document.getElementById("css3Ddiv").addEventListener('click', function () { divclickvalue = true; }, false);;
                } else {
                    change();
                }
            }, 1000)
        }
        change();*/
        function likeHover(html) {
            if (intersects != undefined && intersects.length > 0 && gltfclickvalue == false) {
                //moveMouse = convertTo3DCoordinate(eventMouse.x + canvas.width / 2, eventMouse.y + canvas.height / 2);
                var moveMouse = convertTo3DCoordinate(eventMouse.x + css3Ddivobj.offsetWidth / 2, eventMouse.y + css3Ddivobj.offsetHeight/2);
                //mouseValue == true ? sprite.position.set(moveMouse.x, moveMouse.y, moveMouse.z) : null;
                mouseValue == true && css3Dsprite!=undefined  ? css3Dsprite.position.set(moveMouse.x, moveMouse.y, moveMouse.z) : null;
                document.body.style.cursor = 'pointer';
                if (threeMesh == null || intersects[0].object.name != threeMesh.name) {
                    if (threeMesh) {
                        //threeMesh.material.color.setHex(threeMesh.currentHex);
                        //threeMesh.material.setValues(threeMesh.currentVal);
                        threeMesh.material = threeMesh.currentmaterial;
                    }
                    //canvas.width > canvas.height ? sprite.scale.set(canvas.width / canvas.height, 1, 0) : sprite.scale.set(1, canvas.height / canvas.width, 0);
                    //sprite.material.visible = true;
                    threeMesh = intersects[0].object;
                    var str = "new THREE." + threeMesh.material.type + "(threeMesh.material)";
                    threeMesh.currentmaterial = eval(str);
                    threeMesh.material = normalMaterial;
                    //var htmltext = "<iframe src='http://www.baidu.com'/>";
                    // var htmltext = "<div style='background-color:#FFFFFF;border-radius:5px;padding:8px'>" + Math.random() + "<a href='http://localhost:50905/Web3D.html'>測試" + Math.random() + "</a><div style='color:red'>123</div><input type='submit' value='測試' style='cursor:pointer' onclick='changeClick()'/></div>";
                  var htmltext = html;
                    upcss3Dsprite(htmltext);
                    //改变透明度
                    //threeMesh.currentVal = { transparent: threeMesh.material.transparent, opacity: threeMesh.material.opacity };
                    // threeMesh.material.setValues({ transparent: true, opacity: 0.8 });
                    //改变颜色
                    //threeMesh.currentHex = threeMesh.material.color.getHex();
                    //threeMesh.material.color.setHex(0xffff00);
                    //$("#div_target").html("<span>12345</span>");
                    //getCanvas($("#div_target")[0], 2.56);
                    //var v3d = getMeshcenter(intersects[0].object);
                    //sprite.position.set( 1, 5, 1 );
                    //texture.needsUpdate = true;
                    css3Ddivobj.style.display = "block";
                } else {
                    //texture.needsUpdate = true;
                }
            } else {
                document.body.style.cursor = 'default';
                if (threeMesh) {
                    //threeMesh.material.color.setHex(threeMesh.currentHex);
                    //threeMesh.material.setValues(threeMesh.currentVal);
                    threeMesh.material = threeMesh.currentmaterial;
                }
                threeMesh = null;
                //sprite.material.visible = false;
                //;
                gltfclickvalue == true ? css3Ddivobj.style.display = "block" : css3Ddivobj.style.display = "none";
                //texture.needsUpdate = true;
            }
        }
        //创建精灵用于展示设备信息
        var texture;
        var sprite;
        function creatSprite() {
            texture = new THREE.Texture(canvas)
            //动画
            //annie = new TextureAnimator(texture, 10, 1, 10, 75);
            texture.needsUpdate = true;
            let spriteMaterial = new THREE.SpriteMaterial({ map: texture , depthTest:false });
            sprite = new THREE.Sprite(spriteMaterial);
            //sprite.renderOrder = 99;
            sprite.position.set(5, 5, 0);
            scene.add(sprite);
        }
        //html2canvas将html转为canvas用于贴图
        var canvas = document.createElement("canvas");
        function getCanvas(htmlDom, val) {
            var width = htmlDom.offsetWidth;
            var height = htmlDom.offsetHeight;
            canvas.width = width * val;
            canvas.height = height * val;
            canvas.getContext("2d").scale(val, val);
            var opts = {
                scale: val,
                canvas: canvas,
                width: width,
                height: height,
                useCORS: true
            };

            html2canvas(htmlDom, opts).then(function (canvas) {
                var context = canvas.getContext('2d');
                context.mozImageSmoothingEnabled = false;
                context.webkitImageSmoothingEnabled = false;
                context.msImageSmoothingEnabled = false;
                context.imageSmoothingEnabled = false;
            });
        }
        ////////////////////////
        var css3Ddivobj = document.createElement("div");
        css3Ddivobj.style.display = "none";
        css3Ddivobj.style.cursor = "pointer";
        css3Ddivobj.id = "css3Ddiv";
        var css3Dsprite;
        function upcss3Dsprite(htmltext) {
            css3Ddivobj.innerHTML = htmltext;
            css3Dsprite = new THREE.CSS3DSprite(css3Ddivobj);
            css3Dsprite.position.set(0, 0, 1000);
            cssScene.remove(cssScene.children[0]);
            cssScene.add(css3Dsprite);
        }
        var divclickvalue = false;

            //2维坐标转3维坐标
            function convertTo3DCoordinate(clientX, clientY) {
                var vector = new THREE.Vector3(
                    (clientX / window.innerWidth) * 2 - 1,
                    -(clientY / window.innerHeight) * 2 + 1,
                    0.9975);
                return vector.unproject(camera);
            }
            //3维坐标转2维坐标
            function convertTo2DCoordinate(vector) {
                //获取模型
                //var obj = intersects[0].object;
                //vector = vector.setFromMatrixPosition(obj.matrixWorld).project(camera);

                vector.project(camera)
                let halfWidth = window.innerWidth / 2;
                let halfHeight = window.innerHeight / 2;
                return new THREE.Vector2(vector.x * halfWidth + halfWidth, vector.y * halfHeight + halfHeight);
            }
            var gltfclickvalue = false;
            function onMouseClick(event) {
                if (intersects.length > 0) {

                    //材质信息
                    //var namearray = new Array();
                    //namearray = intersects[0].object.material.name.split('-');
                    //console.log(namearray[namearray.length - 1]);

                    //暂时屏蔽
                    /*var meshName = intersects[0].object.name;
                    var reg = new RegExp("[0-9a-z]{8}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{4}-[0-9a-z]{12}");
                    meshName.match(reg) == null ? $("#c").empty() : mouseClick(meshName.match(reg).toString());*/
                    divclickvalue == false ? divvalefalse() : divvaletrue();
                    function divvalefalse () {
                        gltfclickvalue = true;
                        divclickvalue = false;
                    }
                    function divvaletrue() {
                        gltfclickvalue = false;
                        divclickvalue = false;
                    }
                    /*var texture = new THREE.TextureLoader().load("test.jpg", function (texture) {
                        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                        texture.offset.set(0, 0);
                        texture.repeat.set(1, 1)
                    });*/
                    //var texture = new THREE.TextureLoader().load("test.jpg");
                    //var texture = new THREE.Texture(canvas)
                    //texture.needsUpdate = true;
                    //texture.minFilter = texture.magFilter = THREE.LinearFilter;
                    //texture.mapping = THREE.UVMapping;
                    // var Material = new THREE.MeshPhongMaterial({ map: texture });
                    //intersects[0].object.material = Material;
                    //var textureLoader = new THREE.TextureLoader();
                    /*textureLoader.load("test.jpg", function (texture) {
                        textureLoader.load("test.jpg", function (normalTexture) {
                            intersects[0].object.material.map = texture;
                            intersects[0].object.material.normalMap = normalTexture; // 只要将法向贴图赋给材质的normalMap属性即可
                            intersects[0].object.material.needsUpdate = true;
                        });
                    });*/
                    //intersects[0].object.material.map = texture;
                    //intersects[0].object.material.needsUpdate = true;//材质会更新
                    //intersects[0].object.material = Material;
                    /* var materialClass = {
                         opacity: meshMaterial.opacity,
                         transparent: meshMaterial.transparent
                     }
                     var Material = new THREE.MeshBasicMaterial();
                     Material = intersects[0].object.material;
                     Material.transparent = meshMaterial.transparent;
                     Material.opacity = meshMaterial.opacity;
                     meshMaterial = new THREE.MeshBasicMaterial(Material);
                     intersects[0].object.material = meshMaterial;
                     //动画可删除*/
                    //intersects[0].object
                    /*var box = new THREE.Box3();
                    //计算点击Mesh的几何中心
                    var center = new THREE.Box3().expandByObject(intersects[0].object).getCenter(new THREE.Vector3());
                    //intersects[0].object.position.set(center.x, center.y, center.z);
                    var newMesh = NewObject3D(center.x, center.y, center.z, intersects[0].object);
                    scene.add(newMesh);
                    function draw() {
                        intersects[0].object.rotation.y = (intersects[0].object.rotation.y + 0.1) % (Math.PI * 2);
                    }
                    var sss = setInterval(draw, 1);*/
                  sendToParent(intersects[0].object.name);
                }
            }

            ////////////////////////////////////////添加文字信息///////////////////////////////////////
            //创建3D文字，资源消耗较大(加载文字json)
            function initModel(name, modelName) {
                var font;
                var loader = new THREE.FontLoader();
                loader.load("scripts/FangSong_Regular.json", function (res) {
                    font = new THREE.TextBufferGeometry(name, {
                        font: res,
                        size: 0.1,
                        height: 0.01
                    });
                    font.computeBoundingBox(); // 运行以后设置font的boundingBox属性对象，如果不运行无法获得。
                    var material = new THREE.MeshPhongMaterial({ color: 0xffcc00, side: THREE.DoubleSide });
                    let fontModel = new THREE.Mesh(font, material);
                    //thisobj需要在GLTF加载完成后才能使用
                    var thisobj = scene.getObjectByName('product-1eb10804-77e2-4d38-91a8-740eae813669-body');
                    var center = new THREE.Box3().expandByObject(thisobj).getCenter(new THREE.Vector3());
                    //设置Mesh的name属性方便之后使用查找
                    fontModel.name = modelName;
                    scene.add(NewObject3D1(center.x, center.y, center.z, fontModel));
                });
            }
            //控制3D文字轨道控制器一起旋转
            function Controls3Dtext() {
                if (scene.getObjectByName("qwer123") != undefined) {
                    scene.getObjectByName("qwer123").rotation.x = camera.rotation.x;
                    scene.getObjectByName("qwer123").rotation.y = camera.rotation.y;
                    scene.getObjectByName("qwer123").rotation.z = camera.rotation.z;
                    //scene.getObjectByName("1#水泵").rotation.x = (controls.getPolarAngle() - Math.PI / 2) * Math.abs(Math.cos(controls.getAzimuthalAngle()));
                    //scene.getObjectByName("1#水泵").rotation.y = controls.getAzimuthalAngle() * Math.abs(Math.cos(controls.getPolarAngle() - Math.PI / 2));
                    //scene.getObjectByName("1#水泵").rotation.z = (controls.getPolarAngle() - Math.PI/2) * Math.sin(controls.getAzimuthalAngle())+controls.getAzimuthalAngle()* Math.sin(controls.getPolarAngle() - Math.PI/2);
                }
            }
            //创建2D文字用于显示名称
            function get2Dtext(obj,name,pms) {
                //let spritey = createSpriteText("1#循环水泵");
                let center = new THREE.Box3().expandByObject(obj).getCenter(new THREE.Vector3());
                let spritey = makeTextSprite(name, pms);
                spritey.position.set(center.x, center.y+0.3, center.z);
                scene.add(spritey);
            }

            function createSpriteText(Name) {
                //先用画布将文字画出
                let canvas = document.createElement("canvas");
                let ctx = canvas.getContext("2d");
                ctx.fillStyle = "#ffff00";
                ctx.font = "Bold 100px Arial";
                ctx.lineWidth = 4;
                ctx.fillText(Name, 4, 104);
                let texture = new THREE.Texture(canvas);
                texture.needsUpdate = true;
                //使用Sprite显示文字
                let material = new THREE.SpriteMaterial({ map: texture });
                let textObj = new THREE.Sprite(material);
                textObj.renderOrder = 0;
                textObj.scale.set(0.5, 0.5, 0);
                return textObj;
            }
            function makeTextSprite(message, parameters) {
                if (parameters === undefined) parameters = {};
                var fontface = parameters.hasOwnProperty("fontface") ?
                    parameters["fontface"] : "Arial";
                var fontsize = parameters.hasOwnProperty("fontsize") ?
                    parameters["fontsize"] : 18;
                var borderThickness = parameters.hasOwnProperty("borderThickness") ?
                    parameters["borderThickness"] : 4;
                var borderColor = parameters.hasOwnProperty("borderColor") ?
                    parameters["borderColor"] : { r: 0, g: 0, b: 0, a: 1.0 };
                var backgroundColor = parameters.hasOwnProperty("backgroundColor") ?
                    parameters["backgroundColor"] : { r: 255, g: 255, b: 255, a: 1.0 };
                var canvas = document.createElement('canvas');
                var context = canvas.getContext('2d');
                context.font =  fontsize * 3 + "px " + fontface;
                var metrics = context.measureText(message);
                var textWidth = metrics.width ;
                context.fillStyle = "rgba(" + backgroundColor.r + "," + backgroundColor.g + "," + backgroundColor.b + "," + backgroundColor.a + ")";
                context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + "," + borderColor.b + "," + borderColor.a + ")";
                context.lineWidth = borderThickness;
                roundRect(context, borderThickness / 2, borderThickness / 2, textWidth + borderThickness, fontsize * 3 + borderThickness, 10);
                context.fillStyle = "rgba(0, 0, 0, 1.0)";
                context.fillText(message, borderThickness, fontsize * 2.5 + borderThickness);
                //将生成的canvas作为贴图
                var texture = new THREE.Texture(canvas)
                texture.needsUpdate = true;
                var spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                var sprite = new THREE.Sprite(spriteMaterial);
                sprite.scale.set(1/2, 1/2, 1.0);
                return sprite;
            }
            //添加圆角矩形
            function roundRect(ctx, x, y, w, h, r) {
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.lineTo(x + w - r, y);
                ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                ctx.lineTo(x + w, y + h - r);
                ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                ctx.lineTo(w / 2 - 25, y + h);
                ctx.lineTo(w / 2, y + h + 35);
                ctx.lineTo(w / 2 + 25, y + h);
                ctx.lineTo(x + r, y + h);
                ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                ctx.lineTo(x, y + r);
                ctx.quadraticCurveTo(x, y, x + r, y);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            /*function changeRun() {
                scene.getObjectByName("product-1eb10804-77e2-4d38-91a8-740eae813669-body").material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            }
            function changeStop() {
                scene.getObjectByName("product-1eb10804-77e2-4d38-91a8-740eae813669-body").material = new THREE.MeshBasicMaterial({ color: 0x909090 });
            }
            function changeError() {
                scene.getObjectByName("product-1eb10804-77e2-4d38-91a8-740eae813669-body").material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            }
            function changeNormal() {
                scene.getObjectByName("product-1eb10804-77e2-4d38-91a8-740eae813669-body").material = new THREE.MeshBasicMaterial({ color: 0x909090 });
            }*/


            /*var elem;//= document.getElementById('canvas3d');
            document.addEventListener("mousemove", function (e) {
                var movementX = e.movementX ||
                              e.mozMovementX ||
                              e.webkitMovementX ||
                              0,
                movementY = e.movementY ||
                              e.mozMovementY ||
                              e.webkitMovementY ||
                              0;
                //console.log("movementX=" + movementX, "movementY=" + movementY);
            }, false);

            function fullscreenChange() {
                if (document.webkitFullscreenElement === elem ||
                    document.mozFullscreenElement === elem ||
                    document.mozFullScreenElement === elem) { // 较旧的 API 大写 'S'.
                    // 元素进入全屏模式了，现在我们可以请求指针锁定。
                    elem.requestPointerLock = elem.requestPointerLock ||
                                              elem.mozRequestPointerLock ||
                                              elem.webkitRequestPointerLock;
                    elem.requestPointerLock();
                }
            }

            document.addEventListener('fullscreenchange', fullscreenChange, false);
            document.addEventListener('mozfullscreenchange', fullscreenChange, false);
            document.addEventListener('webkitfullscreenchange', fullscreenChange, false);

            function pointerLockChange() {
                if (document.mozpointerLockElement === elem ||
                    document.webkitpointerLockElement === elem ||
                    document.pointerLockElement === elem) {
                    controls.dispose();
                    initControls();
                    document.getElementById("crosshair").style.opacity = 1;
                } else {
                    controls.dispose();
                    initControls1();
                    document.getElementById("crosshair").style.opacity = 0;
                }
            }

            document.addEventListener('pointerlockchange', pointerLockChange, false);
            document.addEventListener('mozpointerlockchange', pointerLockChange, false);
            document.addEventListener('webkitpointerlockchange', pointerLockChange, false);

            function pointerLockError() {
                console.log("锁定指针时出错。");
            }

            document.addEventListener('pointerlockerror', pointerLockError, false);
            document.addEventListener('mozpointerlockerror', pointerLockError, false);
            document.addEventListener('webkitpointerlockerror', pointerLockError, false);

            function changePointer() {
                elem = document.getElementById("canvas3d");
                elem.requestFullscreen = elem.requestFullscreen ||
                                         elem.mozRequestFullscreen ||
                                         elem.mozRequestFullScreen || // 较旧的 API 把 ‘S’ 大写
                                         elem.webkitRequestFullscreen;
                //elem.requestFullscreen();
                elem.requestPointerLock();
            }*/

            function messagedivShow() {
                var divMessage = "<div id='div_message' style='color:red;width:200px;height:100px;position: absolute;z-index:10'><span>设备信息展示</span></div>";
                $("body").append(divMessage);
            }

            function NewObject3D(x, y, z, obj) {
                let New3D = new THREE.Object3D();
                New3D.add(obj).position.set(x,y,z);
                //let New3D = new THREE.Object3D().add(obj).position.set(x, y, z);
                obj.geometry.center();
                obj.rotation.x = THREE.Math.degToRad(-90);
                obj.rotation.z = THREE.Math.degToRad(180);
                return New3D;
            }
            function NewObject3D1(x, y, z, obj) {
                let New3D = new THREE.Object3D();
                New3D.add(obj).position.set(x, y, z);
                //let New3D = new THREE.Object3D().add(obj).position.set(x, y, z);
                obj.geometry.center();
                return New3D;
            }

            function updateMesh() {
                var obj = scene.getObjectByName("product-1eb10804-77e2-4d38-91a8-740eae813669-body");
                var mpm = new THREE.MeshPhongMaterial({ 'color': '0x0055ff' });
                obj.material = mpm;
                var center = new THREE.Box3().expandByObject(obj).getCenter(new THREE.Vector3());
                var newobj = NewObject3D(center.x, center.y, center.z, obj);
                objects.push(newobj.children[0]);
                scene.add(newobj);
            }

            //辅助坐标
            var clock = new THREE.Clock();
            function initAxis() {
                var axes = new THREE.AxisHelper(10000);
                scene.add(axes);
            }
            //Gui菜单插件
            var meshMaterial = new THREE.MeshBasicMaterial();
            var gui;
            var spGui;
            var messageGui;
            function initGui() {
                var guidata = {
                    rotationSpeed: 0.02,
                    bouncingSpeed: 0.03,
                    "透明度": meshMaterial.opacity,
                    "透明": meshMaterial.transparent,
                    overdraw: meshMaterial.overdraw,
                    "可见": meshMaterial.visible,
                    side: "front",
                    "颜色": meshMaterial.color.getStyle(),
                    wireframe: meshMaterial.wireframe,
                    wireframeLinewidth: meshMaterial.wireframeLinewidth,
                    wireFrameLineJoin: meshMaterial.wireframeLinejoin,
                };
                gui = new dat.GUI();
                spGui = gui.addFolder("控制菜单");
                spGui.add(guidata, '透明度', 0, 1).onChange(function (e) {
                    meshMaterial.opacity = e
                });
                spGui.add(guidata, '透明').onChange(function (e) {
                    meshMaterial.transparent = e
                });
                /*spGui.add(guidata, 'wireframe').onChange(function (e) {
                    meshMaterial.wireframe = e
                });
                spGui.add(guidata, 'wireframeLinewidth', 0, 20).onChange(function (e) {
                    console.log(e);
                    meshMaterial.wireframeLinewidth = e
                });*/
                spGui.add(guidata, '可见').onChange(function (e) {
                    meshMaterial.visible = e
                });
                /*spGui.add(guidata, 'side', ["front", "back", "double"]).onChange(function (e) {
                    console.log(e);
                    switch (e) {
                        case "front":
                            meshMaterial.side = THREE.FrontSide;
                            break;
                        case "back":
                            meshMaterial.side = THREE.BackSide;
                            break;
                        case "double":
                            meshMaterial.side = THREE.DoubleSide
                            break;
                    }
                    meshMaterial.needsUpdate = true;
                    console.log(meshMaterial);
                });*/
                spGui.addColor(guidata, '颜色').onChange(function (e) {
                    meshMaterial.color.setStyle(e)
                });
                //spGui.open();
                var floorGui = gui.addFolder("楼层选择");
                var floors = {
                    "负一层": 0,
                    "一层": 1,
                    "二层": 2,
                    "三层": 3,
                    "四层": 4,
                    "五层": 5,
                    "六层": 6,
                    "七层": 7
                };
                var floorparams = {
                    选择楼层: Object.keys(floors)[0]
                };
                floorGui.add(floorparams, '选择楼层', Object.keys(floors)).onChange(function (e) {
                    //该方式获取属性值兼容性不好
                    /*var ss = "hemiLuminousIrradiances." + e;
                    console.log(eval(ss));*/
                    console.log(floors[e]);
                });
                //var bulbLuminousPowers = {
                /*"110000 lm (1000W)": 110000,*/
                /* "1000W": 110000,
                 "300W": 3500,
                 "100W": 1700,
                 "60W": 800,
                 "40W": 400,
                 "25W": 180,
                 "4W": 20,
                 "关灯": 0
             };
             var hemiLuminousIrradiances = {
                 "moon": 0.001,
                 sun: 0.2
             };
             var params = {
                 阴影: true,
                 exposure: 0.68,*/
                /* bulbPower: Object.keys(bulbLuminousPowers)[2],*/
                /*灯泡亮度: Object.keys(bulbLuminousPowers)[0],
                环境光: Object.keys(hemiLuminousIrradiances)[0]*/
                //其实是半球光照
                //};
                /*messageGui.add(params, '环境光', Object.keys(hemiLuminousIrradiances)).onChange(function (e) {
                    //该方式获取属性值兼容性不好
                    /*var ss = "hemiLuminousIrradiances." + e;
                    console.log(eval(ss));*/
                /*console.log(hemiLuminousIrradiances[e]);
            });
            messageGui.add(params, '灯泡亮度', Object.keys(bulbLuminousPowers)).onChange(function (e) {
                console.log(bulbLuminousPowers[e]);
            });
            messageGui.add(params, 'exposure', 1, 100);*/
                //messageGui.open();

            }
            //性能插件
            var stats;
            function initStats() {
                stats = new Stats();
                document.body.appendChild(stats.dom);
            }

        function changeError(ObjectByName) {
          //scene.getObjectByName("product-de400293-ac90-4085-a0bc-58f5de4d55da-body").material = new THREE.MeshBasicMaterial({ color: 0xff0000 });

          var errobj = scene.getObjectByName(ObjectByName);
          var shishi = errobj.material.color.getHex();
          /*var material = new THREE.MeshBasicMaterial({ color: 0xff0000 });
          var outlineMesh = new THREE.Mesh(errobj.geometry.clone(), material);
          outlineMesh.scale.multiplyScalar(1.05);
          var center = new THREE.Box3().expandByObject(errobj).getCenter(new THREE.Vector3());
          scene.add(NewObject3D(center.x, center.y, center.z, outlineMesh));
          outlineMesh.material.transparent = true;
          /*function draw() {
            outlineMesh.material.opacity = outlineMesh.material.opacity == 0 ? 1 : 0;
            setTimeout(draw, 300);
          }
          draw();*/
          function draw() {
            //outlineMesh.material.opacity = outlineMesh.material.opacity == 0 ? 1 : 0;
            errobj.material.color.getHex() == shishi ? errobj.material.color.setHex(0xff0000) : errobj.material.color.setHex(shishi);
            setTimeout(draw, 300);
          }
          draw();
        }

        //新增两个函数
        function sendToParent(obj) {
          // 向父vue页面发送信息
          window.parent.postMessage({
            cmd: 'getClickObject',
            params: {
              success: true,
              data: obj
            }
          }, '*');
        }

        var html = '';
        // 接受父页面发来的信息
        window.addEventListener("message", function(event){
          var data = event.data;
          switch (data.cmd) {
            case 'getFormJson':
              var jsonData = data.params.html;
              var str = '';
              for (let i=0;i<jsonData.length;i++){
                str += `<ul style="display: table-row">
                          <li style="display: table-cell">${jsonData[i].tit}</li>
                          <li style="display: table-cell;padding-left: 10px;color:#fff">${jsonData[i].val}</li>
                        </ul>`
              }
              html = `<div style="position: absolute;top: 100px;z-index: 1000000;min-width: 190px;min-height:239px;background-color: #04152c;">
              <div style="display: table;padding: 10px;font-family: PingFangSC-Regular;font-size: 14px;line-height:44px;font-weight: normal;font-stretch: normal;letter-spacing: 0px;color: #4f648b;">

              ${str}
              <button type="button" style="background-color: #3a84ee;border-radius: 4px;border: solid 1px #1989fa;font-size: 14px;line-height: 1;color: #ffffff;padding:8px 20px;" onclick="changeClick()">去关联</button>
              </div>
              </div>`;
              console.log(html);
              changeError(data.params.data)
              console.log('子页面收到了',data.params.data);
              // 处理业务逻辑
              break;
          }
        });
    </script>
</head>
<body onload='threeStart();' style="overflow: hidden">
    <div id="c" style="position: absolute;left: 10px;bottom: 60px;height:auto"></div>
    <div id="crosshair1" style="position: absolute;z-index:-1"><div id="div_target" style="color:red;width:200px;height:100px"><span>设备信息展示</span></div></div>
    <div id="canvas3d"></div>
    <div id="crosshair"></div>
</body>
</html>



